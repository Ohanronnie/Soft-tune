let express = require('express');
let app = express();
let bodyparser = require('body-parser');
let parser = bodyparser.urlencoded({extended: false});
let cookieparser = require('cookie-parser');
app.use(cookieparser());
app.use('/public',express.static('public'));
app.use(bodyparser.urlencoded({extended: false}));
app.set('view engine','ejs');
let formidable = require('formidable');
let db = require('./test.js');
let decrypt = text => {
   return atob(atob(atob(text)))
}
//show the file
app.get('/upload.html',function(req,res){
  res.render('project/home/upload');
});
//control the form
app.post('/upload',function(req,res){
  let form = new formidable.IncomingForm();
  form.parse(req,function(err,fields,files){
   let music = fields.music;
   let cover = fields.cover;
   let name = fields.name;
   let lyrics = fields.lyrics;
   let artist = fields.artist;
   let description = fields.description;
   let array = [music,cover,name,lyrics,artist,description];
   console.log(array);
   async function connect(){
     try{
     let result = db.pool.query('INSERT INTO music(music,cover,name,artist,lyrics,description) VALUES ?',[music,cover,name,artist,lyrics,description])
     console.log(result)
    }
    catch(err){
    console.log(err)
    }
  }
  connect()
 });
});
app.get('/login',function(req,res){
  res.render('project/home/index',{
  message: ''
}) 
});
app.post('/index',function(req,res){
  let form = new formidable.IncomingForm();
  form.parse(req,function(err,fields,files){
   let username = fields.name;
   let password = fields.password;
   async function connect(){
    try{
      const result = await db.pool.query(`SELECT * FROM data WHERE number = '${username}' and password = '${password}'`)
      console.log(result);
        if(result.length == 0 || result == undefined){
        res.render('project/home/index',{
          message: 'Incorrect Password'
        });
      }
      else{
        res.cookie('Login_data',
        {
        user: btoa(btoa(btoa(username))),
        pass: btoa(btoa(btoa(password)))
        },{
        maxAge: 1000 * 60 * 60 * 24 * 3,
        // expires works the same as the maxAge
        secure: true,
        httpOnly: true,
        sameSite: 'lax'
        });
        let logindata = btoa('Login-data');
        console.log(req.cookies);
        console.log(req.cookies.Login_data)
        res.render('project/files/index')
     }
     }
     catch(err){
      throw err;
    }
   }
  connect();
   });
});
app.get('/index',function(req,res){
  console.log(req)
 /* if(req.cookies.Login_data == undefined || req.cookies.Login_data == "undefined"){
    res.render('project/home/index',{
    message: 'You must login to continue'
 });
 }
 else{*/
   let username = decrypt(req.cookies.Login_data.user);
   let pass = decrypt(req.cookies.Login_data.user);
   res.render('project/files/index',{
   user: username
  });
// };
});
app.get('/signup',function(req,res){
  res.render('project/home/signup',{
  message: ''
});
});
app.post('/signin',function(req,res){
  let form = new formidable.IncomingForm();
  form.parse(req,function(err,fields,files){
    let username = fields.name;
    let password = fields.pass;
    let mail = fields.mail;
      async function connect() {
      try{
          let test = await db.pool.query(`SELECT * FROM data WHERE number = '${username}'`);
          let result = await db.pool.query(`INSERT INTO data (number,password,mail) VALUES ('${username}','${password}','${mail}')`)
          console.log([username,password,mail]);
          console.log('ADDED TO DATABASE');
          res.render('project/home/index',{
          message: ''
         })
      }
      catch(err){
        throw(err)
      }
      }
    connect()
 });
});
app.get('/check',function(req,res){
  async function check(){
    let result = await db.pool.query(`SELECT * FROM data WHERE number = '${req.query.data}'`);
    res.send(result);
    console.log(req.query.data)
  };
 check()
});
app.listen(8080,() => {
console.log('Server is active at port 8080');
})
